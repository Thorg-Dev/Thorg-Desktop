<?xml version='1.0' encoding='windows-1252'?>
<?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?define Win64 = "yes" ?>
<?define Version="0.0.3"?>
<?define BuildOutputDir="..\bin\Release"?>
<?define YaPubDir="F:\gminer"?>
<?define YaBuildOutputDir="F:\yagna\target\release"?>
<?define ClaymoreDir="F:\gminer\plugins\claymore-real"?>
<?define MediaDir="$(var.SolutionDir)\Media"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
        Id='*'
        Name='Golem Provider'
        UpgradeCode='{96497EC7-11EA-4257-A0E4-37688d0C7EC0}'
        Manufacturer='golemfactory'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>
    <Package Id='*'
           Keywords='Installer'
            Manufacturer='golemfactory'
            InstallerVersion='450'
            Languages='1033'
            Compressed='yes'
            InstallScope='perMachine'
            SummaryCodepage='1252'
            Platform='x64'/>
    <MajorUpgrade
        Schedule='afterInstallInitialize'
        DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

    <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
    <!-- Allow upgrades and prevent downgrades -->
    <!--MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." /-->
    <Property Id='DiskPrompt' Value='Golem Installation'/>

    <!--Condition Message="Required vc++ runtime version 14.22.27812.0 or newer">
    		<![CDATA[Installed OR VCRUNTIMEVERSION]]>
	</Condition-->
    
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="fa2a64b9-19f8-4830-a931-18de65ed4e26">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Golem Provider UI"
                  Target="[APPLICATIONFOLDER]GolemUI.Exe"
                  WorkingDirectory="APPLICATIONFOLDER"/>
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\GolemFactory\GolemProviderUI" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>
    
    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Golem"/>
      </Directory>
      <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='GolemProvider'>
          <Component Id='License' Guid='8aa900e0-cca3-49e0-9e1f-0692d8a3ab29' Win64='$(var.Win64)'>
            <File Id='LicenseFile'
                Name='License'
                DiskId='1'
                Source='LICENSE.rtf'
                KeyPath='yes'/>
          </Component>
          <Component Id='GolemNode' Guid='a2223e0a-f321-4895-a84c-fcaff67633a0' Win64='$(var.Win64)'>
            <File Id='yagnaExe'
                  Name='yagna.exe'
                  DiskId='1'
                  Source='$(var.YaBuildOutputDir)\yagna.exe'
                  KeyPath='yes'>
            </File>

          </Component>
          <Component Id='GolemProvider' Guid='8ffef653-0847-4789-8b37-8c0f90f6a43f' Win64='$(var.Win64)'>
            <File Id='yaproviderExe'
                  Name='ya-provider.exe'
                  DiskId='1'
                  Source='$(var.YaBuildOutputDir)\ya-provider.exe'
                  KeyPath='yes'>
            </File>
          </Component>
          <Directory Id="Plugins" Name="plugins">
            <Component Id="WasmDriver" Guid="c7bd0747-16aa-4c7c-a895-9e2b39394dc9" Win64="$(var.Win64)">
              <File Id="wasmDriverExe" Name="ya-runtime-wasi.exe" DiskId="1" Source="$(var.YaPubDir)\plugins\ya-runtime-wasi.exe" KeyPath="yes"/>
            </Component>
            <Component Id="WasmDriverManifest" Guid="f07ae8b2-d3cb-46d7-badc-e1b432e5945c" Win64="$(var.Win64)">
              <File Id="wasmDriverManifest" Name="ya-runtime-wasi.json" DiskId="1" Source="$(var.YaPubDir)\plugins\ya-runtime-wasi.json" KeyPath="yes"/>
            </Component>
            <Component Id="CoreExeUnit" Guid="5aa3012f-93d4-4605-970f-c3eb2d66e486" Win64="$(var.Win64)">
              <File Name="exe-unit.exe" DiskId="1" Source="$(var.YaPubDir)\plugins\exe-unit.exe" KeyPath="yes"/>
            </Component>
            <Component Id='GMineDriver' Guid="eebc7614-db08-4129-8619-461c07feb3b8" Win64="$(var.Win64)">
              <File Name='ya-runtime-gminer.exe' DiskId='1' Source='$(var.YaPubDir)\plugins\ya-runtime-gminer.exe' KeyPath='no'/>
              <File Name='ya-runtime-gminer.json' DiskId='1' Source='$(var.YaPubDir)\plugins\ya-runtime-gminer.json' KeyPath='no'/>
            </Component>
            <Directory Id='dir29FA238D75D949F99B06F199E7C9EE82' Name='claymore'>
              <Directory Id="dir00796F504E8DC0DE85A40C6033069E84" Name="cuda10" />
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature
        Id='MainProgram'
        Title='Provider Runtime'
        Description='Installs the executable and license.'
        Level='1'
        ConfigurableDirectory='APPLICATIONFOLDER'
        AllowAdvertise='no'
        Display='expand'
        Absent='disallow'>
      <ComponentRef Id='License'/>

      <ComponentRef Id='GolemNode'/>
      <ComponentRef Id='GolemProvider'/>
      <ComponentGroupRef Id='ProductFilesComponentGroup'/>
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>
    <Feature
        Id='f.wasm'
        Title='Wasm Driver'
        Description='Installs Golem Wasm Driver'
        Level='1'
        ConfigurableDirectory='APPLICATIONFOLDER'
        AllowAdvertise='no'
        Display='expand'
        Absent='allow'>
      <ComponentRef Id='License'/>
      <ComponentRef Id='WasmDriver'/>
      <ComponentRef Id='WasmDriverManifest'/>
      <ComponentRef Id='CoreExeUnit'/>
    </Feature>
    <Feature
        Id='f.gmine'
        Title='Eth mining Driver'
        Description='Installs Golem Mining Driver'
        Level='1'
        ConfigurableDirectory='APPLICATIONFOLDER'
        AllowAdvertise='no'
        Display='expand'
        Absent='allow'>
      <ComponentRef Id='License'/>
      <ComponentRef Id='GMineDriver'/>
      <ComponentGroupRef Id='Claymore'/>
    </Feature>


    <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
    <SetProperty Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" After='CostFinalize' />
    <UI>
      <UIRef Id='WixUI_FeatureTree'/>
      <!--UIRef Id='WixUI_Minimal'/-->
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction"
      Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    <WixVariable Id='WixUILicenseRtf' Value='LICENSE.rtf'/>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Start Golem" />
    <CustomAction Id='LaunchApplication' ExeCommand='[APPLICATIONFOLDER]GolemUI.Exe setup' Return="asyncNoWait" Directory="APPLICATIONFOLDER"/>

  </Product>
  <Fragment>
    <ComponentGroup Id="Claymore">
      <Component Id="cmpB310AB10842068918754AC7C6B84DEE0" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*"  Win64="$(var.Win64)">
        <File Id="filB16B13A71393DA0213F7BFFD243D0CC5" KeyPath="yes" Source="$(var.ClaymoreDir)\cudart64_80.dll" />
      </Component>
      <Component Id="cmp1CD257EFDF83C46E0D61FBFB85303976" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*"  Win64="$(var.Win64)">
        <File Id="filC741C00F7B71872CF3DD622CC3000F37" KeyPath="yes" Source="$(var.ClaymoreDir)\Datapack.bin" />
      </Component>
      <Component Id="cmpBDD0A97F3962239C33328AA9732F6FDD" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*"  Win64="$(var.Win64)">
        <File Id="fil0676D469E9A5A5EFA1F5756FB0EA7F67" KeyPath="yes" Source="$(var.ClaymoreDir)\dpools.txt" />
      </Component>
      <Component Id="cmp3F0296D258AE2ADEC3862467FF5ACEE4" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*"  Win64="$(var.Win64)">
        <File Id="filF7E293359F00E8210813C554B368C39D" KeyPath="yes" Source="$(var.ClaymoreDir)\EIO.dll" />
      </Component>
      <Component Id="cmp687E8E46492A08BA12A0839EC2B38161" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*"  Win64="$(var.Win64)">
        <File Id="fil3E57B661218F7361B61B2973DA07470B" KeyPath="yes" Source="$(var.ClaymoreDir)\EIO.exe" />
      </Component>
      <Component Id="cmp02CC639CD1AE57D813736DFE39156A0C" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="filE046C07CA3659648EB86872DE457C16B" KeyPath="yes" Source="$(var.ClaymoreDir)\epools.txt" />
      </Component>
      <Component Id="cmp763493F9D846C5064AE666B124AC2B52" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil2EAF4EA17877474C1127415AEED10BB9" KeyPath="yes" Source="$(var.ClaymoreDir)\EthDcrMiner64.exe" />
      </Component>
      <Component Id="cmpB3E999D2577B8E184A5E42CAE3792BFE" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil95758CC4E313BC081330770DB9C48D91" KeyPath="yes" Source="$(var.ClaymoreDir)\History.txt" />
      </Component>
      <Component Id="cmpEC32EDF0CA8B8536BB7F5EBE70A7A076" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil7C64988F6DDF21ADFFA9215AE6C586E9" KeyPath="yes" Source="$(var.ClaymoreDir)\IOMap64.sys" />
      </Component>
      <Component Id="cmpD1AAD8625F1331050BB5749EF4B294E2" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil088F9D02F8E884F49F6E6D934B618D1B" KeyPath="yes" Source="$(var.ClaymoreDir)\libcurl.dll" />
      </Component>
      <Component Id="cmpAA687BF574AD609FFF3FE7604B799627" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil0CDF3B65ACAAABC1EBAC2A3D8D7A6CDB" KeyPath="yes" Source="$(var.ClaymoreDir)\License.txt" />
      </Component>
      <Component Id="cmp31CAB86A81F74D85430E31387C1AAAED" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil1593EFEE9B1A8FC44C79AEFC82DD1B85" KeyPath="yes" Source="$(var.ClaymoreDir)\msvcr110.dll" />
      </Component>
      <Component Id="cmp16B6EF098AEDC275FC41340733E1C060" Directory="dir29FA238D75D949F99B06F199E7C9EE82" Guid="*" Win64="$(var.Win64)">
        <File Id="fil8505837F23F1AD62A614E35AF2F88214" KeyPath="yes" Source="$(var.ClaymoreDir)\Readme!!!.txt" />
      </Component>
      <Component Id="cmp064E574274933534A7E0A47246C2DAE7" Directory="dir00796F504E8DC0DE85A40C6033069E84" Guid="*" Win64="$(var.Win64)">
        <File Id="fil92FF7D0A8E451BD503FAC7D17230810F" KeyPath="yes" Source="$(var.ClaymoreDir)\cuda10\cudart64_100.dll" />
      </Component>
      <Component Id="cmp6EE8F54E3B9387154F581B34F6905501" Directory="dir00796F504E8DC0DE85A40C6033069E84" Guid="*" Win64="$(var.Win64)">
        <File Id="fil451B3578321F4F54CE08842B91F32064" KeyPath="yes" Source="$(var.ClaymoreDir)\cuda10\EthDcrMiner64.exe" />
      </Component>
    </ComponentGroup>
  </Fragment>
  <Fragment>
    <Property Id="VCRUNTIMEVERSION">
      <DirectorySearch Id="SystemFolderDriverVersion" Path="[SystemFolder]">
        <FileSearch Name="vcruntime140.dll" MinVersion="14.22.27821.0"/>
      </DirectorySearch>
    </Property>
    <PackageGroup Id="redist_vc140">
      <ExePackage Id="vc140" Cache="yes" PerMachine="yes" Permanent="yes" Vital="yes" Compressed="yes"
             SourceFile="redist\vcredist_x64.exe"
             InstallCommand="/quiet /norestart"
       DetectCondition="(VCRUNTIMEVERSION &gt;= 14.22.27821.0)" />
    </PackageGroup>
  </Fragment>
</Wix>